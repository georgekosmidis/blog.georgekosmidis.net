<!DOCTYPE html><html lang=en prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><base href=https://blog.georgekosmidis.net/how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials.html><meta name=viewport content="width=device-width, initial-scale=1"><meta name=description content="This is a guide on how to make requests to a protected resource using  Client Credentials  with the  IdentityServer4.Contrib.HttpClientService  nuget package. The library is actually an  HttpClient  service that makes it easy to make authenticated and resilient HTTP requests to protected by  IdentityServer4  resources. Additionally, more features include automatic complex type serialization for requests / deserialization for responds (using  Json.NET ), caching of the token response to reduce load and an  HttpRequestMessage  factory that adds an “ X-HttpClientService ” header for logging/tracking between cascading API calls."><meta name=author content="George Kosmidis"><meta http-equiv=Content-Security-Policy content="script-src 'nonce-31e0b69a-8356-480a-9a8a-7336997af6a2'"><link rel=me type=text/html href=https://github.com/georgekosmidis><link rel=me type=text/html href="https://www.linkedin.com/in/georgekosmidis/"><link rel=me type=text/html href=https://www.youtube.com/c/GeorgeKosmidis><link rel=me type=text/html href="https://sessionize.com/georgekosmidis/"><link rel=me type=text/html href="https://www.meetup.com/munich-dotnet-meetup/members/202480733/profile/"><link rel=me type=text/html href="https://georgekosmidis.net/"><link rel=icon type=image/jpg href=/media/me_180x180.jpg><link rel=apple-touch-icon type=image/jpg sizes=180x180 href=/media/me_180x180.jpg><meta property=og:title content="How to make authenticated requests to an ASP.NET Core web API using IdentityServer4 with Client Credentials."><meta property=og:type content=article><meta property=og:url content=https://blog.georgekosmidis.net/how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials.html><meta property="og:description " content="This is a guide on how to make requests to a protected resource using  Client Credentials  with the  IdentityServer4.Contrib.HttpClientService  nuget package. The library is actually an  HttpClient  service that makes it easy to make authenticated and resilient HTTP requests to protected by  IdentityServer4  resources. Additionally, more features include automatic complex type serialization for requests / deserialization for responds (using  Json.NET ), caching of the token response to reduce load and an  HttpRequestMessage  factory that adds an “ X-HttpClientService ” header for logging/tracking between cascading API calls."><meta property=og:article:published_time content="03/16/2020 13:01:00"><meta property=og:article:modified_time content="03/17/2020 19:46:14"><meta property=og:article:expiration_time content="12/31/9999 23:59:59"><meta property=og:article:author content="George Kosmidis"><meta property=og:article:section content=""><meta property=og:article:tag content=" ASP.NET Core, Client Credentials, HttpClient, HttpClientService, IdentityServer4, nuget, OAuth 2.0, OpenID, Web API"><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3 crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.4.0/styles/vs2015.min.css integrity="sha256-Pi771++jBrwgeHVYGOa1sjN8idXlrrYSKQVI7+JA54k=" crossorigin=anonymous><title>How to make authenticated requests to an ASP.NET Core web API using IdentityServer4 with Client Credentials.</title><style>header{background-image:url(/media/header_bg.jpg);background-size:cover;background-position:100% 100%}header svg{width:25px;fill:#f8f9fa}footer svg{width:25px;fill:black}.me{width:180px;height:180px}.article{overflow-wrap:break-word;word-wrap:break-word;-ms-word-break:break-all;word-break:break-all;word-break:break-word}.article img{max-width:100%;height:auto}h1,h2,h3,h4,h5,h6{font-weight:400}h2{margin-top:4rem}.right-column-container h2,.index-card-wrapper h2{margin-top:0}.h3,h3{margin-top:3rem;font-size:1.65rem}.h4,h4{font-size:1.4eem}.h5,h5{font-size:1.2eem}.h4,.h5,h4,h5{margin-top:2rem}th,strong,b{font-weight:500}a{text-decoration:none}a:hover{text-decoration:underline}a.btn svg{margin-bottom:3px}.article-google-engine-top,.article-google-engine-left{display:none}@media (min-width:992px){.container{max-width:1200px}header > .container{max-width:768px}.article-google-engine-left{display:block}td{padding:10px}}@media (max-width:991.98px){.container{padding-right:calc(var(--bs-gutter-x) * .3);padding-left:calc(var(--bs-gutter-x) * .3)}.article-google-engine-top{display:block}td{padding:5px 2px 5px 2px}}blockquote{text-rendering:optimizelegibility;font-weight:400;line-height:160%;box-sizing:inherit;background-color:#DEEBFF;outline-color:#171717;color:#171717;word-wrap:break-word;word-break:break-word;border:1px solid #DEEBFF;border-radius:.375rem;margin-top:1rem;padding:1rem;font-size:1rem;transition:height .5s ease-in,opacity .5s ease-in;display:block;position:relative}blockquote p{margin-bottom:0}dfn{border-color:#343a40}</style><script async src="https://www.googletagmanager.com/gtag/js?id=UA-3071108-41" nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><script nonce=31e0b69a-8356-480a-9a8a-7336997af6a2>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-3071108-41');</script></head><body class=bg-light><header class="container-fluid p-3 bg-dark border-bottom"> <div class="container text-white"> <div class=row> <div class="col-sm-12 col-md-3 text-center"> <a href="/"> <img src=/media/me_180x180.jpg class="rounded-circle border border-white border-5 me" alt="George Kosmidis - This is a guide on how to make requests to a protected resource using  Client Credentials  with the  IdentityServer4.Contrib.HttpClientService  nuget package. The library is actually an  HttpClient  service that makes it easy to make authenticated and resilient HTTP requests to protected by  IdentityServer4  resources. Additionally, more features include automatic complex type serialization for requests / deserialization for responds (using  Json.NET ), caching of the token response to reduce load and an  HttpRequestMessage  factory that adds an “ X-HttpClientService ” header for logging/tracking between cascading API calls."> </a> </div> <div class="col-sm-12 col-md-9"> <div class=container> <div class=row> <div class=col> <h1 class="display-5 text-center">George Kosmidis</h1> <small class="d-block text-center mt-3">Microsoft MVP | Speaks of Azure, AI & .NET | Founder of Munich .NET <br> Building tomorrow @<div style=display:none>slalom</div> <img src=/media/slalom_small.png title=slalom alt=slalom></small> </div> </div> <div class="row mt-3"> <div class="col text-center"> <a href=https://github.com/georgekosmidis target=_blank class=btn rel=noopener> <svg role=img class=icon viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg> </a> <a href="https://www.linkedin.com/in/georgekosmidis/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg> </a> <a href=https://www.youtube.com/c/GeorgeKosmidis target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>YouTube</title><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"></path></svg> </a> <a href="https://sessionize.com/georgekosmidis/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 288 288" xmlns=http://www.w3.org/2000/svg><title>Sessionize</title><g transform="translate(0.000000,288.000000) scale(0.100000,-0.100000)"><path d="M135 2861 c-22 -10 -54 -34 -72 -52 -67 -71 -63 22 -63 -1369 0 -1391 -4 -1298 63 -1369 70 -73 42 -71 715 -71 l602 0 0 40 c0 108 -52 232 -127 301 -92 85 -229 125 -469 139 -119 6 -160 13 -190 28 -63 32 -96 81 -108 161 -6 43 12 87 470 1118 263 590 480 1073 483 1073 3 0 22 -42 41 -92 47 -127 157 -344 228 -453 156 -239 367 -450 607 -608 100 -65 373 -202 478 -238 37 -13 67 -27 67 -30 0 -3 -348 -160 -772 -349 -425 -188 -777 -346 -782 -350 -4 -5 11 -18 35 -30 235 -119 367 -331 394 -633 l7 -77 482 0 c444 0 484 2 521 19 51 23 111 89 125 138 8 27 10 249 8 773 -4 660 -6 743 -22 809 -69 289 -197 522 -396 721 -199 199 -432 327 -721 396 -67 16 -148 18 -819 21 -712 3 -747 2 -785 -16z m2069 -483 c99 -51 198 -181 200 -264 1 -57 -21 -79 -77 -78 -137 3 -328 220 -288 328 19 50 84 55 165 14z"></path></g></svg> </a> <a href="https://www.meetup.com/munich-dotnet-meetup/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Meetup</title><path d="M6.98.555a.518.518 0 0 0-.105.011.53.53 0 1 0 .222 1.04.533.533 0 0 0 .409-.633.531.531 0 0 0-.526-.418zm6.455.638a.984.984 0 0 0-.514.143.99.99 0 1 0 1.02 1.699.99.99 0 0 0 .34-1.36.992.992 0 0 0-.846-.482zm-3.03 2.236a5.029 5.029 0 0 0-4.668 3.248 3.33 3.33 0 0 0-1.46.551 3.374 3.374 0 0 0-.94 4.562 3.634 3.634 0 0 0-.605 4.649 3.603 3.603 0 0 0 2.465 1.597c.018.732.238 1.466.686 2.114a3.9 3.9 0 0 0 5.423.992c.068-.047.12-.106.184-.157.987.881 2.47 1.026 3.607.24a2.91 2.91 0 0 0 1.162-1.69 4.238 4.238 0 0 0 2.584-.739 4.274 4.274 0 0 0 1.19-5.789 2.466 2.466 0 0 0 .433-3.308 2.448 2.448 0 0 0-1.316-.934 4.436 4.436 0 0 0-.776-2.873 4.467 4.467 0 0 0-5.195-1.656 5.106 5.106 0 0 0-2.773-.807zm-5.603.817a.759.759 0 0 0-.423.135.758.758 0 1 0 .863 1.248.757.757 0 0 0 .193-1.055.758.758 0 0 0-.633-.328zm15.994 2.37a.842.842 0 0 0-.47.151.845.845 0 1 0 1.175.215.845.845 0 0 0-.705-.365zm-8.15 1.028c.063 0 .124.005.182.014a.901.901 0 0 1 .45.187c.169.134.273.241.432.393.24.227.414.089.534.02.208-.122.369-.219.984-.208.633.011 1.363.237 1.514 1.317.168 1.199-1.966 4.289-1.817 5.722.106 1.01 1.815.299 1.96 1.22.186 1.198-2.136.753-2.667.493-.832-.408-1.337-1.34-1.12-2.26.16-.688 1.7-3.498 1.757-3.93.059-.44-.177-.476-.324-.484-.19-.01-.34.081-.526.362-.169.255-2.082 4.085-2.248 4.398-.296.56-.67.694-1.044.674-.548-.029-.798-.32-.72-.848.047-.31 1.26-3.049 1.323-3.476.039-.265-.013-.546-.275-.68-.263-.135-.572.07-.664.227-.128.215-1.848 4.706-2.032 5.038-.316.576-.65.76-1.152.784-1.186.056-2.065-.92-1.678-2.116.173-.532 1.316-4.571 1.895-5.599.389-.69 1.468-1.216 2.217-.892.387.167.925.437 1.084.507.366.163.759-.277.913-.412.155-.134.302-.276.49-.357.142-.06.343-.095.532-.094zm10.88 2.057a.468.468 0 0 0-.093.011.467.467 0 0 0-.36.555.47.47 0 0 0 .557.36.47.47 0 0 0 .36-.557.47.47 0 0 0-.464-.37zm-22.518.81a.997.997 0 0 0-.832.434 1 1 0 1 0 1.39-.258 1 1 0 0 0-.558-.176zm21.294 2.094a.635.635 0 0 0-.127.013.627.627 0 0 0-.48.746.628.628 0 0 0 .746.483.628.628 0 0 0 .482-.746.63.63 0 0 0-.621-.496zm-18.24 6.097a.453.453 0 0 0-.092.012.464.464 0 1 0 .195.908.464.464 0 0 0 .356-.553.465.465 0 0 0-.459-.367zm13.675 1.55a1.044 1.044 0 0 0-.583.187 1.047 1.047 0 1 0 1.456.265 1.044 1.044 0 0 0-.873-.451zM11.4 22.154a.643.643 0 0 0-.36.115.646.646 0 0 0-.164.899.646.646 0 0 0 .899.164.646.646 0 0 0 .164-.898.646.646 0 0 0-.54-.28z"></path></svg> </a> </div> </div> </div> </div> </div> </div> </header> <main class="container bg-light pt-4 pb-5"> <div class="row masonry"> <div class=container> <div class="row mx-auto article-google-engine-top"> <div class="col pb-4"> <div class="card text-center bg-transparent border-0" style=height:33px><script async src="https://cse.google.com/cse.js?cx=c67a1214306f44e87" nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><div class=gcse-searchbox-only></div> </div> </div> </div> <div class="row mx-auto"> <div class="col-lg-8 mb-4 shadow bg-white rounded"> <div class="container article"> <div class="row border-end border-start border-bottom bg-light"> <div class=col style=text-align:center> <a class="btn align-middle" href=https://github.com/georgekosmidis/blog.georgekosmidis.net//tree/main/workables/articles/100290-how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials/content.html role=button style=text-decoration:none target=_blank rel=noopener> <svg xmlns=http://www.w3.org/2000/svg width=22 height=22 fill=currentColor viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" /></svg> Edit Page </a> <a class="btn align-middle" href="https://github.com/georgekosmidis/blog.georgekosmidis.net//issues/new?permalink=https://github.com/georgekosmidis/blog.georgekosmidis.net//tree/main/workables/articles/100290-how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials/content.html" role=button style=text-decoration:none target=_blank rel=noopener> <svg xmlns=http://www.w3.org/2000/svg width=22 height=22 fill=currentColor viewBox="0 0 24 24"><path fill-rule=evenodd d="M2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0zM12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 13a2 2 0 100-4 2 2 0 000 4z"></path></svg> Create Issue </a> <a class="btn align-middle" href="https://github.com/georgekosmidis/blog.georgekosmidis.net/discussions/new?title=How to make authenticated requests to an ASP.NET Core web API using IdentityServer4 with Client Credentials.&amp;body=Article%20URL:%20https://blog.georgekosmidis.net//how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials.html" role=button style=text-decoration:none target=_blank rel=noopener> <svg aria-hidden=true height=22 viewBox="0 0 16 16" width=22><path fill-rule=evenodd d="M1.5 2.75a.25.25 0 01.25-.25h8.5a.25.25 0 01.25.25v5.5a.25.25 0 01-.25.25h-3.5a.75.75 0 00-.53.22L3.5 11.44V9.25a.75.75 0 00-.75-.75h-1a.25.25 0 01-.25-.25v-5.5zM1.75 1A1.75 1.75 0 000 2.75v5.5C0 9.216.784 10 1.75 10H2v1.543a1.457 1.457 0 002.487 1.03L7.061 10h3.189A1.75 1.75 0 0012 8.25v-5.5A1.75 1.75 0 0010.25 1h-8.5zM14.5 4.75a.25.25 0 00-.25-.25h-.5a.75.75 0 110-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0114.25 12H14v1.543a1.457 1.457 0 01-2.487 1.03L9.22 12.28a.75.75 0 111.06-1.06l2.22 2.22v-2.19a.75.75 0 01.75-.75h1a.25.25 0 00.25-.25v-5.5z"></path></svg> Discuss </a> <a class="btn ms-4" href="/" role=button style=text-decoration:none> <svg xmlns=http://www.w3.org/2000/svg width=22 height=22 class=mb-1 fill=currentColor class="bi bi-house-fill" viewBox="0 0 16 16"><path fill-rule=evenodd d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6zm5-.793V6l-2-2V2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5z"></path><path fill-rule=evenodd d="M7.293 1.5a1 1 0 0 1 1.414 0l6.647 6.646a.5.5 0 0 1-.708.708L8 2.207 1.354 8.854a.5.5 0 1 1-.708-.708L7.293 1.5z"></path></svg> Go Home </a> </div> </div> <div class=row> <div class="col mt-3"> <h1 class="text-center display-6">How to make authenticated requests to an ASP.NET Core web API using IdentityServer4 with Client Credentials.</h1> </div> </div> <div class=row> <div class="col pb-2"> <div class="text-black-50 text-center"> <small>by <a href="https://georgekosmidis.net/" rel=noopener>George Kosmidis</a> / Published 5 years and 4 months ago</small> </div> </div> </div> <div class=row> <div class="col pt-3 pb-6"> <p>This is a guide on how to make requests to a protected resource using <em>Client Credentials</em> with the <a href="https://www.nuget.org/packages/IdentityServer4.Contrib.HttpClientService/" rel="noopener noreferrer" target=_blank>IdentityServer4.Contrib.HttpClientService</a> nuget package. The library is actually an <code>HttpClient</code> service that makes it easy to make authenticated and resilient HTTP requests to protected by <a href=http://identityserver4.readthedocs.io rel="noopener noreferrer" target=_blank>IdentityServer4</a> resources. Additionally, more features include automatic complex type serialization for requests / deserialization for responds (using <code>Json.NET</code>), caching of the token response to reduce load and an <code>HttpRequestMessage</code> factory that adds an &#8220;<code>X-HttpClientService</code>&#8221; header for logging/tracking between cascading API calls.</p> <p></p> <h2 id=h2_toc>Table of Contents</h2> <ol><li><a href=#h2_install>Install the nuget package</a></li> <li><a href=#h2_settings>Add the settings to <code>appsettings.json</code></a></li> <li><a href=#h2_register>Register the service</a></li> <li><a href=#h2_request>Make a request</a></li> <li><a href=#h2_access_token_request>How to setup an Access Token Request</a></li> <ul><li><a href=#h3_set_identity_server_options_string>SetIdentityServerOptions(String)</a></li> <li><a href=#h3_set_identity_server_options_toptions>SetIdentityServerOptions&lt;TOptions&gt;(TOptions)</a></li> <li><a href=#h3_set_identity_server_options_ioptions>SetIdentityServerOptions&lt;TOptions&gt;(IOptions&lt;TOptions&gt;)</a></li> <li><a href=#h3_set_identity_server_options_action>SetIdentityServerOptions&lt;TOptions&gt;(Action&lt;TOptions&gt;)</a></li></ul><li><a href=#h2_more>More info on how to serialize requests, deserialize responses</a></li> <ul><li><a href=#h3_responseobject>ResponseObject&lt;TResponseBody&gt;</a></li> <li><a href=#h3_typecontent>TypeContent(TRequestBody, Encoding, string)</a></li></ul><li><a href=#h2_headers>Attaching headers to the request</a></li> <ul><li><a href=#h3_headers_headersadd_string>HeadersAdd(String, String)</a></li> <li><a href=#h3_headers_headersadd_list_string>HeadersAdd(String, List&lt;String&gt;)</a></li> <li><a href=#h3_headers_headersadd_dictionary>HeadersAdd(Dictionary&lt;String, String&gt;)</a></li> <li><a href=#h3_headers_headersadd_dictionary_list>HeadersAdd(Dictionary&lt;String, List&lt;String&gt;&gt;)</a></li> <li><a href=#h3_headers_headersclear>HeadersClear()</a></li> <li><a href=#h3_headers_headersremove>HeadersRemove(String)</a></li></ul><li><a href=#h2_conclusion>Conclusion</a></li></ol> <h2 id=h2_install>Install the nuget package</h2> <p>Install the <a href=https://www.nuget.org/packages/IdentityServer4.Contrib.HttpClientService>IdentityServer4.Contrib.HttpClientService</a> nuget package, using either the <a href="https://docs.microsoft.com/en-us/nuget/quickstart/install-and-use-a-package-in-visual-studio?WT.mc_id=DT-MVP-5004591" rel="noopener noreferrer" target=_blank>Package Manager</a> or <code>.NET CLI</code>, or any other method:</p> <p><code>> dotnet add package IdentityServer4.Contrib.HttpClientService --version 2.2.1</code></p> <h2 id=h2_settings>Add the settings to <code>appsettings.json</code></h2> <p>The IdentityServer4 settings can be passed in using one of the <code>SetIdentityServerOptions</code> overloads which are explored later in section &#8220;<a href=#h2_access_token_request>How to setup an Access Token Request</a>&#8220;. Although it is always a good idea to keep the code clean of any hard-coded values and use the <code>appsettings.json</code>, this step is only necessary for the <a href=#h3_set_identity_server_options_string><code>SetIdentityServerOptions(String)</code></a> overload.</p> <p><pre><code class=language-csharp>//The values here are part of the demo offered in https://demo.identityserver.io/
{
    //...
    "SomeClientCredentialsOptions": {
        "Address": "https://demo.identityserver.io/connect/token",
        "ClientId": "m2m",
        "ClientSecret": "secret",
        "Scopes": "api"
    }
    //...
}</code></pre></p> <blockquote><p>The configuration section should always be or end with <code>ClientCredentialsOptions</code>. In the example before, the section name was &#8220;<code>SomeClientCredentialsOptions</code>&#8220;.</p></blockquote> <h2 id=h2_register>Register the service</h2> <p>Although there is a singleton instance (<code>HttpClientServiceFactory.Instance</code>) available, using DI for ASP.NET Core WebAPIs is the <em>only</em> way to go. The library uses internally typed clients and thus the <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests?WT.mc_id=DT-MVP-5004591" rel="noopener noreferrer" target=_blank>HttpClientFactory</a> to create resilient HTTP requests and avoid socket exhaustion issues. </p> <blockquote><p><a href="https://www.stevejgordon.co.uk/" rel="noopener noreferrer" target=_blank>Steve Gordon</a> explores HttpClient internals and potential problems in <a href=https://www.stevejgordon.co.uk/httpclient-creation-and-disposal-internals-should-i-dispose-of-httpclient rel="noopener noreferrer" target=_blank>HttpClient creation and disposal internals: Should I dispose of HttpClient?</a></p></blockquote> <p>In the following example, the <code>HttpClientService</code> is registered in <code>Startup.cs</code> in <code>ConfigureServices(IServiceCollection services)</code> without configuring any options. This is still possible, as some of the <code>SetIdentityServerOptions</code> overloads allow late configuration but it excludes the use of the <code>SetIdentityServerOptions(IOptions&lt;&gt;)</code> overload:<br> <pre><code class=language-csharp>//...
    public void ConfigureServices(IServiceCollection services)
    {
        //...
        services.AddHttpClientService();    //Adds the HTTP client service to the service collection
        //For typed configuration use: .Configure&lt;ClientCredentialsOptions&gt;(Configuration.GetSection(nameof(ClientCredentialsOptions)));
        //...
    }
//...</code></pre></p> <p>As mentioned, the approach above did not include options configuration and the <code>SetIdentityServerOptions(IOptions&lt;&gt;)</code> overload was excluded. In the example that follows, multiple custom services are registered and configured, allowing the use of the options pattern:</p> <p><pre><code class=language-csharp>//...
    public void ConfigureServices(IServiceCollection services)
    {
        //...
        services.AddHttpClientService()
            .AddSingleton&lt;IYourCustomService, YourCustomService&gt;()
            .Configure&lt;SomeClientCredentialOptions&gt;(Configuration.GetSection(nameof(SomeClientCredentialOptions)))
            .AddSingleton&lt;IYourCustomService2, YourCustomService2&gt;()
            .Configure&lt;DifferentClientCredentialOptions&gt;(Configuration.GetSection(nameof(DifferentClientCredentialOptions)));           //...
    }
//...</code></pre></p> <h2 id=h2_request>Make a request</h2> <p>Either if it is a controller or any custom service, the constructor of that class should request an <code>IHttpClientServiceFactory</code> instance. The injected singleton instance (in the example below <code>_requestServiceFactory</code>), can then be used to create an <code>HttpClientService</code> instance that will hold all common information for all the requests that will be carried out by that instance. That allows adding <code>IdentityServer4</code> options and <code>Headers</code> only once, and then using the same <code>HttpClientService</code> multiple times:</p> <p><pre><code class=language-csharp>using IdentityServer4.Contrib.HttpClientService.Extensions;

[ApiController]
[Route("customers")]
public class CustomerController : ControllerBase
{
	//Request the IHttpClientServiceFactory instance in your controller or service
	private readonly HttpClientService _httpClientService;
	
	public CustomerController(IHttpClientServiceFactory requestServiceFactory){
		_httpClientService = requestServiceFactory
			//Create a instance of the service
			.CreateHttpClientService()
			//Set the settings for the IdentityServer4 authentication
			.SetIdentityServerOptions("ClientCredentialsOptions")			
	}

	[HttpGet]
	public async Task&lt;IActionResult&gt; Get(){
		//Make the request
		var responseObject = await _httpClientService			
			//GET and deserialize the response body to IEnumerable&lt;Customers&gt;
			.GetAsync&lt;IEnumerable&lt;Customers&gt;&gt;("https://api/customers");

		//Do something with the results					  
		if (!responseObject.HasError)
		{
			var customers = responseObject.BodyAsType;
			return Ok(customers);
		}
		else
		{
			var httpStatusCode = responseObject.StatusCode;
			var errorMessage = responseObject.Error;           
			return StatusCode((int)httpStatusCode, errorMessage);
		}
	}
}</code></pre></p> <p>Similarly enough, all the HTTP verbs are supported. In the example that follows, a new action is added that uses the same <code>HttpClientService</code> for a POST request:<br> <pre><code class=language-csharp>using IdentityServer4.Contrib.HttpClientService.Extensions;

[ApiController]
[Route("customers")]
public class CustomerController : ControllerBase
{
	//Request the IHttpClientServiceFactory instance in your controller or service
	private readonly HttpClientService _httpClientService;
	
	public CustomerController(IHttpClientServiceFactory requestServiceFactory){
		_httpClientService = requestServiceFactory
			//Create a instance of the service
			.CreateHttpClientService()
			//Set the settings for the IdentityServer4 authentication
			.SetIdentityServerOptions("ClientCredentialsOptions")			
	}

	[HttpGet]
	public async Task&lt;IActionResult&gt; Get(){
		//Make the request
		var responseObject = await _httpClientService			
			//GET and deserialize the response body to IEnumerable&lt;Customers&gt;
			.GetAsync&lt;IEnumerable&lt;Customers&gt;&gt;("https://api/customers");

		//Do something with the results					  
		if (!responseObject.HasError)
		{
			var customers = responseObject.BodyAsType;
			return Ok(customers);
		}
		else
		{
			var httpStatusCode = responseObject.StatusCode;
			var errorMessage = responseObject.Error;           
			return StatusCode((int)httpStatusCode, errorMessage);
		}
	}

	[HttpPost]
	public async Task&lt;IActionResult&gt; Post([FromBody]CustomerForRequest customerForRequest){
		//Make the request
		var responseObject = await _httpClientService
			//Execute a POST request by setting the type of the request body to CustomerForRequest 
			// and Response to CustomerFromResponse
			.PostAsync&lt;CustomerForRequest, CustomerFromResponse&gt;("https://api/customers", customerForRequest);

		//Do something with the results					  
		if (!responseObject.HasError)
		{
			var customerFromResponse = responseObject.BodyAsType;
			return Ok(customerFromResponse);
		}
		else
		{
			var httpStatusCode = responseObject.StatusCode;
			var errorMessage = responseObject.Error;           
			return StatusCode((int)httpStatusCode, errorMessage);
		}
	}
}</code></pre></p> <blockquote><p>The <code>SetIdentityServerOptions("SomeClientCredentialsOptions")</code> might be the simplest way of setting up an Access Token Request, the <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?WT.mc_id=DT-MVP-5004591" rel="noopener noreferrer" target=_blank>Options Pattern</a> though is the suggested way. Explore in the following section &#8220;<a href=#h2_access_token_request>How to setup an Access Token Request</a>&#8220;, all the ways of setting up IdentityServer options.</p></blockquote> <p>Following are the most useful extension methods for an HTTP request:</p> <ul><li><code>GetAsync&lt;TResponseBody&gt;(String requestUri)</code><br>Sends a GET request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServiceGetExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>GetAsync</code> extension methods.</li> <li><code>PostAsync&lt;TRequestBody,TResponseBody&gt;(String requestUri, TRequestBody requestBody)</code><br>Sends a POST request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the request will be of type TRequestBody and will be serialized using Json.NET. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServicePostExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>PostAsync</code> extension methods.</li> <li><code>PutAsync&lt;TRequestBody,TResponseBody&gt;(String requestUri, TRequestBody requestBody)</code><br>Sends a PUT request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the request will be of type TRequestBody and will be serialized using Json.NET. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServicePutExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>PutAsync</code> extension methods.</li> <li><code>DeleteAsync&lt;TResponseBody&gt;(String requestUri)</code><br>Sends a DELETE request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServiceDeleteExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>DeleteAsync</code> extension methods.</li> <li><code>PatchAsync&lt;TRequestBody,TResponseBody&gt;(String requestUri, TRequestBody requestBody)</code><br>Sends a PATCH request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the request will be of type TRequestBody and will be serialized using Json.NET. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServicePatchExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>PatchAsync</code> extension methods.</li> <li><code>HeadAsync&lt;TResponseBody&gt;(String requestUri)</code><br>Sends a HEAD request to the specified <code>requestUri</code> and returns the response wrapped in a <a href=#h3_responseobject><code>ResponseObject&lt;TResponseBody&gt;</code></a> object in an asynchronous operation. The body of the response will be deserialized to <code>TResponseBody</code> using <code>Json.NET</code>. Check the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Extensions.HttpClientServiceHeadExtensions.html rel="noopener noreferrer" target=_blank>documentation</a> for a full list of the <code>HeadAsync</code> extension methods.</li></ul> <h2 id=h2_access_token_request>How to setup an Access Token Request</h2> <p>The library supports multiple ways for setting up the necessary options to retrieve an access token, with the <code>SetIdentityServerOptions</code> overloads. Upon success of retrieving one, the result is cached until the token expires; that means that a new request to a protected resource does not necessarily means a new request for an access token.</p> <h3 id=h3_set_identity_server_options_string>SetIdentityServerOptions(String)</h3> <p>Setup IdentityServer options by defining the configuration section where the settings exist. The type of the options (<code>ClientCredentialsOptions</code> or <code>PasswordOptions</code>) will be determined based on the name of the section (it should be or end with &#8220;<code>ClientCredentialsOptions</code>&#8221; or &#8220;<code>PasswordOptions</code>&#8220;):</p> <p><pre><code class=language-csharp>//...
_requestService = requestServiceFactory
	//Create a instance of the service
	.CreateHttpClientService()
	//Set the settings for the IdentityServer4 authentication
	.SetIdentityServerOptions("ClientCredentialsOptions")	
//...</code></pre></p> <p>Although this option is not very useful for <code>PasswordTokenRequest</code>, the section can contain the properties of either the <code><a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Models.ClientCredentialsOptions.html rel="noopener noreferrer" target=_blank>ClientCredentialsOptions</a></code> or <code><a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Models.PasswordOptions.html rel="noopener noreferrer" target=_blank>PasswordOptions</a></code> objects. </p> <blockquote><p>For the <code>SetIdentityServerOptions(String)</code> to work, the configuration section name should either be or end with <code>ClientCredentialsOptions</code>.</p></blockquote> <blockquote><p>Read the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.HttpClientService.html#IdentityServer4_Contrib_HttpClientService_HttpClientService_SetIdentityServerOptions_System_String_ rel="noopener noreferrer" target=_blank>technical specifications</a> of the <code>SetIdentityServerOptions(String)</code> in the documents.</p></blockquote> <h3 id=h3_set_identity_server_options_toptions>SetIdentityServerOptions&lt;TOptions&gt;(TOptions)</h3> <p>Setup IdentityServer options by passing a <code><a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Models.ClientCredentialsOptions.html rel="noopener noreferrer" target=_blank>ClientCredentialsOptions</a></code> or <code><a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.Models.PasswordOptions.html rel="noopener noreferrer" target=_blank>PasswordOptions</a></code> object directly to the <code>SetIdentityServerOptions&lt;TOptions&gt;(TOptions)</code>:</p> <p><pre><code class=language-csharp>//...
_httpClientService = requestServiceFactory
	//Create a instance of the service
	.CreateHttpClientService()
	//Set the settings for the IdentityServer4 authentication
	.SetIdentityServerOptions(
		new PasswordOptions
			{
			Address = "https://demo.identityserver.io/connect/token",
			ClientId = "ClientId",
			ClientSecret = "ClientSecret",
			Scope = "Scope",
			Username = "Username",
			Password = "Password"
			}
		)
//...</code></pre></p> <blockquote><p>Read the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.HttpClientService.html#IdentityServer4_Contrib_HttpClientService_HttpClientService_SetIdentityServerOptions__1___0_ rel="noopener noreferrer" target=_blank>technical specifications</a> of the <code>SetIdentityServerOptions&lt;TOptions&gt;(TOptions)</code> in the documents.</p></blockquote> <h3 id=h3_set_identity_server_options_ioptions>SetIdentityServerOptions&lt;TOptions&gt;(IOptions&lt;TOptions&gt;)</h3> <p>Setup IdentityServer options using the options pattern (read more about the options pattern in <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?WT.mc_id=DT-MVP-5004591" rel="noopener noreferrer" target=_blank>Microsoft Docs</a>):</p> <p><strong>Startup.cs</strong><br> <pre><code class=language-csharp>//...
    public void ConfigureServices(IServiceCollection services)
    {
        //...
        services.AddHttpClientService()
            .AddSingleton&lt;IProtectedResourceService, ProtectedResourceService&gt;()
            .Configure&lt;ClientCredentialsOptions&gt;(Configuration.GetSection(nameof(ClientCredentialsOptions)));    
        //...
    }
//...</code></pre><br> <strong>ProtectedResourceService.cs</strong><br> <pre><code class=language-csharp>//...
public class ProtectedResourceService : IProtectedResourceService
{
    private readonly IHttpClientServiceFactory _requestServiceFactory;
    private readonly IOptions&lt;ClientCredentialsOptions&gt; _identityServerOptions;

    public ProtectedResourceService(IHttpClientServiceFactory requestServiceFactory, IOptions&lt;ClientCredentialsOptions&gt; identityServerOptions)
    {
        _requestServiceFactory = requestServiceFactory;
        _identityServerOptions = identityServerOptions;
    }

    public async Task&lt;YourObject&gt; Get(){
        _requestServiceFactory
        .CreateHttpClientService()
        .SetIdentityServerOptions(_identityServerOptions)
        .GetAsync&lt;YourObject&gt;("https://url_that_returns_YourObject");
    }
)
//...</code></pre></p> <blockquote><p>Read the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.HttpClientService.html#IdentityServer4_Contrib_HttpClientService_HttpClientService_SetIdentityServerOptions__1_Microsoft_Extensions_Options_IOptions___0__ rel="noopener noreferrer" target=_blank>technical specifications</a> of the <code>SetIdentityServerOptions&lt;TOptions&gt;(IOptions&lt;TOptions&gt;)</code> in the documents.</p></blockquote> <h3 id=h3_set_identity_server_options_action>SetIdentityServerOptions&lt;TOptions&gt;(Action&lt;TOptions&gt;)</h3> <p>Setup IdentityServer options using a delegate:<br> <pre><code class=language-csharp>//...
_httpClientService = requestServiceFactory
	//Create a instance of the service
	.CreateHttpClientService()
	//Set the settings for the IdentityServer4 authentication
	.SetIdentityServerOptions&lt;PasswordOptions&gt;( x =&gt; {
		  x.Address = "https://demo.identityserver.io/connect/token";
		  x.ClientId = "ClientId";
		  x.ClientSecret = "ClientSecret";
		  x.Scope = "Scope";
		  x.Username = "Username";
		  x.Password = "Password";
		}
	)
//...</code></pre></p> <blockquote><p>Read the <a href=https://georgekosmidis.github.io/IdentityServer4.Contrib.HttpClientService/api/IdentityServer4.Contrib.HttpClientService.HttpClientService.html#IdentityServer4_Contrib_HttpClientService_HttpClientService_SetIdentityServerOptions__1_System_Action___0__ rel="noopener noreferrer" target=_blank>technical specifications</a> of the <code>SetIdentityServerOptions&lt;TOptions&gt;(IOptions&lt;TOptions&gt;)</code> in the documents.</p></blockquote> <h2 id=h2_more>More info on how to serialize requests, deserialize responses</h2> <p>Responses will be deserialized to the type <code>TResponseBody</code> of all the <code>SendAsync&lt;TRequestBody, TResponseBody&gt;(Uri, HttpMethod, TRequestBody)</code> extension methods. The example that follows uses the <code>GetAsync&lt;TResponseBody&gt;(String)</code> extension method to sent GET request to the URL passed as argument; the response then is deserialized to a <code>ResponsePoco</code> instance :<br> <pre><code class=language-csharp>//...
var responseObject = await _requestServiceFactory
    .CreateHttpClientService()
    .GetAsync&lt;ResponsePoco&gt;("https://url_that_returns_ResponsePoco_in_json");
//...</code></pre></p> <p>Requests that contain a body (POST, PUT and PATCH) behave similar, by deserializing the response body and serializing the request body. In the example that follows the type <code>TRequestBody</code> of the <code>PostAsync&lt;TRequestBody,TResponseBody&gt;()</code> extension method defines the type of the <code>requestPoco</code> object. The request will be serialized and attached in the request body using <code>JsonConvert.SerializeObject(requestPoco, Formatting.None)</code>. :<br> <pre><code class=language-csharp>//...
var responseObject = await _requestServiceFactory
    .CreateHttpClientService()
    .PostAsync&lt;RequestPoco,ResponsePoco&gt;("https://url_that_accepts_RequestPoco_and_responds_with_ResponsePoco", requestPoco);
//...</code></pre></p> <blockquote><p>Use the <code>TypeContent(TRequestBody, Encoding, string)</code> to set the media type and encoding of a request body. Without using <code>TypeContent(...)</code> to explitily set media-type and encoding, the defaults will be <code>application/json</code> and <code>UTF-8</code>.</p></blockquote> <h3 id=h3_responseobject>ResponseObject&lt;TResponseBody&gt;</h3> <p>The object returned by all extension methods (GetAsync, PostAsync, PutAsync etc) is of type <code>ResponseObject&lt;TResponseBody&gt;</code> and contains multiple properties. Three of them, the properties starting with &#8220;BodyAs&#8230;&#8221;, hold the body of the response either as <code>String</code>, as <code>Stream</code> or as <code>TResponseBody</code>. Follows, a list of all properties and a quick explanation:</p> <ul><li><code>Stream BodyAsStream</code> This property is populated by setting the <code>TResponseBody</code> to <code>Stream</code>, e.g. <code>GetAsync&lt;Stream&gt;(...)</code>.</li> <li><code>String BodyAsString</code> Unless the <code>TResponseBody</code> is defined as <code>Stream</code>, this will always contain the body of the respone as a raw string.</li> <li><code>TResponseBody BodyAsType</code> The property will attempt to deserialize the raw string of the response to <code>TResponseBody</code>, e.g. <code>GetAsync&lt;CustomerModel&gt;(...)</code>.</li> <li><code>String Error</code> The error, if any, of the request attempt.</li> <li><code>bool HasError</code> A boolean indicating if the something went wrong with the request.</li> <li><code>HttpResponseHeaders Headers</code> A collection of the response headers.</li> <li><code>HttpRequestMessge HttpRequestMessge</code> The entire <code>HttpRequestMessage</code> for debugging purposes.</li> <li><code>HttpResponseMessage HttpResponseMessage</code> The entire <code>HttpResponseMessage</code>.</li> <li><code>HttpStatusCode StatusCode</code> The HttpStatusCode returned.</li></ul> <h3 id=h3_typecontent>TypeContent(TRequestBody, Encoding, string)</h3> <p>Allowing the library to serialize an object and attach it to a request in the body, will by default set the <code>Content-Type</code> header to <code>application/json; charset=utf-8</code>. This default behavior can change with the <code>TypeContent(TRequestBody, Encoding, string)</code> class:</p> <p><pre><code class=language-csharp>var responseObject = await _requestServiceFactory
    //Create a instance of the service
    .CreateHttpClientService()
    //.PostAsync&lt;TRequestBody,TResponseBody&gt;(URL, customer of type Customer1)
    .PostAsync&lt;TypeContent&lt;CustomerForRequest&gt;,CustomerFromResponse&gt;(
                                            "https://api/customers", 
                                            new TypeContent(customerForRequest, Encoding.UTF8, "application/json")
    );</code></pre></p> <h2 id=h2_headers>Attaching headers to the request</h2> <p>Header management is done using a set of methods that adhere to the general method chaining approach. Although in total 6 methods, they actually do two jobs, adding or removing headers. In the list that follows, the first four methods add headers, and the last two remove:</p> <h3 id=h3_headers_headersadd_string>HeadersAdd(String, String)</h3> <p>Adds a header to the request. If a second header with the same name already exists, their values will be aggregated to a List&lt;T&gt;, which will result in the values passes as comma separated in the request.</p> <h3 id=h3_headers_headersadd_list_string>HeadersAdd(String, List&lt;String&gt;)</h3> <p>Adds a header to the request. If a second header with the same name already exists, their values will be aggregated to a List&lt;T&gt;, which will result in the values passes as comma separated in the request.</p> <h3 id=h3_headers_headersadd_dictionary>HeadersAdd(Dictionary&lt;String, String&gt;)</h3> <p>Adds a collection of headers in the request using a Dictionary&lt;String,String&gt;, where the Key of the Dictionary is the header name and the value is the header value. If a second header with the same name already exists, their values will be aggregated to a List&lt;T&gt;, which will result in the values passes as comma separated in the request.</p> <h3 id=h3_headers_headersadd_dictionary_list>HeadersAdd(Dictionary&lt;String, List&lt;String&gt;&gt;)</h3> <p>Adds a collection of headers in the request using a Dictionary&lt;String,List&lt;String&gt;&gt;, where the Key of the Dictionary is the header name and the value is a list of header values. If a second header with the same name already exists, their values will be aggregated to a List&lt;T&gt;, which will result in the values passes as comma separated in the request.</p> <h3 id=h3_headers_headersclear>HeadersClear()</h3> <p>Clears all headers from the request. Use method chaining to reset headers for an <code>HttpClientService</code>, e.g. <code>httpClientService.HeadersClear().HeadersAdd(...)</code></p> <h3 id=h3_headers_headersremove>HeadersRemove(String)</h3> <p>Removes header from the headers collection by name. Use method chaining to reset headers for an <code>HttpClientService</code>, e.g. <code>httpClientService.HeadersRemove("X-Header").HeadersAdd("X-Header",...)</code></p> <p>The following example use method chaining to illustrate a rather non realistic scenario of using all methods:<br> <pre><code class=language-csharp>var responseObject = await _requestServiceFactory
    .CreateHttpClientService()
    //Adds a header to the request, key-value style.
    .HeadersAdd("X-Custom-Header", "value")
    //Adds a header to the request, key-value style, where the value is actually a list of values.
    .HeadersAdd("X-Custom-Header", new List&lt;String&gt;{ "value1", "value2" })
    //Adds a collection of headers in the request using a Dictionary&lt;String,String&gt;, 
    // where the Key of the Dictionary is the header name and the value is the header value
    .HeadersAdd(new Dictionary&lt;String,String&gt;{ {"X-Custom-Header", "value"} })  
    //Adds a collection of headers in the request using a Dictionary&lt;String,String&gt;, 
    // where the Key of the Dictionary is the header name and the value is the header value
    .HeadersAdd(new Dictionary&lt;String,List&lt;String&gt;&gt;{ {"X-Custom-Header", {"value1","value2"}} })  
  
    //Continue setting identity server option, making call etc 
  .PostAsync&lt;RequestPoco,ResponsePoco&gt;("https://url_that_accepts_RequestPoco_and_responds_with_ResponsePoco", requestPoco);</code></pre></p> <h2 id=h2_conclusion>Conclusion</h2> <p>The <a href=https://github.com/georgekosmidis/IdentityServer4.Contrib.HttpClientService rel="noopener noreferrer" target=_blank>IdentityServer4.Contrib.HttpClientService</a> fluent interface makes it easy to create request to protected by IdentityServer4 resources. More over, it makes your code cleaner, by enabling you to preset an <code>HttpClientService</code> with the identity server options needed to login and / or any additional headers you might need. For example, in the following gist the options for the identity server and a custom header is set once, and multiple GET requests are sent in the loop using the same <code>HttpClientService</code>:</p> <p><pre><code class=language-csharp>public class YourService
{
	//Request the IHttpClientServiceFactory instance in your controller or service
	private readonly HttpClientService _httpClientService;
	
	public CustomerController(IHttpClientServiceFactory requestServiceFactory)
	{
		_httpClientService = requestServiceFactory
            //Create a instance of the service
            .CreateHttpClientService()
            //Set the settings for the IdentityServer4 authentication
            .SetIdentityServerOptions("ClientCredentialsOptions")			
            //Add a custom header
            .HeadersAdd("X-Header", "some-value")
    }

	public async Task SentSomeNumbers(IEnumerable&lt;int&gt; someNumbers)
	{
        foreach(var i in someNumbers) {
            //Reuse the HttpClientService
            await _httpClientService.GetAsync("https://api/sent_me_numbers")
        }
	}
}</code></pre></p> <p>Check the code on <a href=https://github.com/georgekosmidis/IdentityServer4.Contrib.HttpClientService rel="noopener noreferrer" target=_blank>Github</a>, and give it a star if you like it! The library is available as a nuget package with the name <a href="https://www.nuget.org/packages/IdentityServer4.Contrib.HttpClientService/" rel="noopener noreferrer" target=_blank>IdentityServer4.Contrib.HttpClientService</a>.</p> </div> </div> <div class="row border-end border-start border-top bg-light mt-4"> <div class="col pt-2" style=text-align:center> This page is <strong>open source</strong>. Noticed a typo? Or something unclear?<br> <a class="btn align-middle" href=https://github.com/georgekosmidis/blog.georgekosmidis.net//tree/main/workables/articles/100290-how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials/content.html role=button style=text-decoration:none target=_blank rel=noopener> <svg xmlns=http://www.w3.org/2000/svg width=22 height=22 fill=currentColor viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" /></svg> Edit Page </a> <a class="btn align-middle" href="https://github.com/georgekosmidis/blog.georgekosmidis.net//issues/new?permalink=https://github.com/georgekosmidis/blog.georgekosmidis.net//tree/main/workables/articles/100290-how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials/content.html" role=button style=text-decoration:none target=_blank rel=noopener> <svg xmlns=http://www.w3.org/2000/svg width=22 height=22 fill=currentColor viewBox="0 0 24 24"><path fill-rule=evenodd d="M2.5 12a9.5 9.5 0 1119 0 9.5 9.5 0 01-19 0zM12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zm0 13a2 2 0 100-4 2 2 0 000 4z"></path></svg> Create Issue </a> <a class="btn align-middle" href="https://github.com/georgekosmidis/blog.georgekosmidis.net/discussions/new?title=How to make authenticated requests to an ASP.NET Core web API using IdentityServer4 with Client Credentials.&amp;body=Article%20URL:%20https://blog.georgekosmidis.net//how-to-make-authenticated-requests-to-an-asp-net-core-web-api-using-identityserver4-with-client-credentials.html" role=button style=text-decoration:none target=_blank rel=noopener> <svg aria-hidden=true height=22 viewBox="0 0 16 16" version=1.1 width=22 data-view-component=true class="octicon octicon-comment-discussion UnderlineNav-octicon d-none d-sm-inline"><path fill-rule=evenodd d="M1.5 2.75a.25.25 0 01.25-.25h8.5a.25.25 0 01.25.25v5.5a.25.25 0 01-.25.25h-3.5a.75.75 0 00-.53.22L3.5 11.44V9.25a.75.75 0 00-.75-.75h-1a.25.25 0 01-.25-.25v-5.5zM1.75 1A1.75 1.75 0 000 2.75v5.5C0 9.216.784 10 1.75 10H2v1.543a1.457 1.457 0 002.487 1.03L7.061 10h3.189A1.75 1.75 0 0012 8.25v-5.5A1.75 1.75 0 0010.25 1h-8.5zM14.5 4.75a.25.25 0 00-.25-.25h-.5a.75.75 0 110-1.5h.5c.966 0 1.75.784 1.75 1.75v5.5A1.75 1.75 0 0114.25 12H14v1.543a1.457 1.457 0 01-2.487 1.03L9.22 12.28a.75.75 0 111.06-1.06l2.22 2.22v-2.19a.75.75 0 01.75-.75h1a.25.25 0 00.25-.25v-5.5z"></path></svg> Discuss </a> </div> </div> </div> </div> <div class=col-lg-4> <div class="container px-0 mx-0 right-column-container"> <div class="col mb-4"> <div class="card text-center bg-transparent border-0" style=height:33px><script async src="https://cse.google.com/cse.js?cx=c67a1214306f44e87" nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><div class=gcse-searchbox-only></div> </div> </div> <div class="col mb-4"> <div class="card shadow"> <img src=/media/mvp.png class="bd-placeholder-img card-img-top" alt="Microsoft MVP - George Kosmidis"> <a href=https://mvp.microsoft.com/en-us/PublicProfile/5004591 target=_blank title="Microsoft MVP - George Kosmidis" class=stretched-link rel=noopener></a> </div> </div> <div class="col mb-4"> <div class="card shadow"> <img src=/media/azure-architecture-icons.png class="bd-placeholder-img card-img-top" alt="Azure Architecture Icons - SVGs, PNGs and draw.io libraries"> <a href=/azure-architecture-icons.html target=_top title="Azure Architecture Icons - SVGs, PNGs and draw.io libraries" class=stretched-link rel=noopener></a> </div> </div> </div> </div> </div> <div class=col-lg-4> &nbsp; </div> </div> </div> </div> </main> <footer class="footer mt-auto py-3 border-top"> <div class="container mx-auto text-center"> <a href=https://github.com/georgekosmidis target=_blank class=btn rel=noopener> <svg role=img class=icon viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg> </a> <a href="https://www.linkedin.com/in/georgekosmidis/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg> </a> <a href=https://www.youtube.com/c/GeorgeKosmidis target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>YouTube</title><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"></path></svg> </a> <a href="https://sessionize.com/georgekosmidis/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 288 288" xmlns=http://www.w3.org/2000/svg><title>Sessionize</title><g transform="translate(0.000000,288.000000) scale(0.100000,-0.100000)"><path d="M135 2861 c-22 -10 -54 -34 -72 -52 -67 -71 -63 22 -63 -1369 0 -1391 -4 -1298 63 -1369 70 -73 42 -71 715 -71 l602 0 0 40 c0 108 -52 232 -127 301 -92 85 -229 125 -469 139 -119 6 -160 13 -190 28 -63 32 -96 81 -108 161 -6 43 12 87 470 1118 263 590 480 1073 483 1073 3 0 22 -42 41 -92 47 -127 157 -344 228 -453 156 -239 367 -450 607 -608 100 -65 373 -202 478 -238 37 -13 67 -27 67 -30 0 -3 -348 -160 -772 -349 -425 -188 -777 -346 -782 -350 -4 -5 11 -18 35 -30 235 -119 367 -331 394 -633 l7 -77 482 0 c444 0 484 2 521 19 51 23 111 89 125 138 8 27 10 249 8 773 -4 660 -6 743 -22 809 -69 289 -197 522 -396 721 -199 199 -432 327 -721 396 -67 16 -148 18 -819 21 -712 3 -747 2 -785 -16z m2069 -483 c99 -51 198 -181 200 -264 1 -57 -21 -79 -77 -78 -137 3 -328 220 -288 328 19 50 84 55 165 14z"></path></g></svg> </a> <a href=https://www.facebook.com/groups/msdevtech target=_blank class=btn rel=noopener> <svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 400 400" role=img><path d="M353.701,0H55.087C24.665,0,0.002,24.662,0.002,55.085v298.616c0,30.423,24.662,55.085,55.085,55.085 h147.275l0.251-146.078h-37.951c-4.932,0-8.935-3.988-8.954-8.92l-0.182-47.087c-0.019-4.959,3.996-8.989,8.955-8.989h37.882 v-45.498c0-52.8,32.247-81.55,79.348-81.55h38.65c4.945,0,8.955,4.009,8.955,8.955v39.704c0,4.944-4.007,8.952-8.95,8.955 l-23.719,0.011c-25.615,0-30.575,12.172-30.575,30.035v39.389h56.285c5.363,0,9.524,4.683,8.892,10.009l-5.581,47.087 c-0.534,4.506-4.355,7.901-8.892,7.901h-50.453l-0.251,146.078h87.631c30.422,0,55.084-24.662,55.084-55.084V55.085 C408.786,24.662,384.124,0,353.701,0z" /></svg> </a> <a href="https://www.meetup.com/munich-dotnet-meetup/" target=_blank class=btn rel=noopener> <svg role=img viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><title>Meetup</title><path d="M6.98.555a.518.518 0 0 0-.105.011.53.53 0 1 0 .222 1.04.533.533 0 0 0 .409-.633.531.531 0 0 0-.526-.418zm6.455.638a.984.984 0 0 0-.514.143.99.99 0 1 0 1.02 1.699.99.99 0 0 0 .34-1.36.992.992 0 0 0-.846-.482zm-3.03 2.236a5.029 5.029 0 0 0-4.668 3.248 3.33 3.33 0 0 0-1.46.551 3.374 3.374 0 0 0-.94 4.562 3.634 3.634 0 0 0-.605 4.649 3.603 3.603 0 0 0 2.465 1.597c.018.732.238 1.466.686 2.114a3.9 3.9 0 0 0 5.423.992c.068-.047.12-.106.184-.157.987.881 2.47 1.026 3.607.24a2.91 2.91 0 0 0 1.162-1.69 4.238 4.238 0 0 0 2.584-.739 4.274 4.274 0 0 0 1.19-5.789 2.466 2.466 0 0 0 .433-3.308 2.448 2.448 0 0 0-1.316-.934 4.436 4.436 0 0 0-.776-2.873 4.467 4.467 0 0 0-5.195-1.656 5.106 5.106 0 0 0-2.773-.807zm-5.603.817a.759.759 0 0 0-.423.135.758.758 0 1 0 .863 1.248.757.757 0 0 0 .193-1.055.758.758 0 0 0-.633-.328zm15.994 2.37a.842.842 0 0 0-.47.151.845.845 0 1 0 1.175.215.845.845 0 0 0-.705-.365zm-8.15 1.028c.063 0 .124.005.182.014a.901.901 0 0 1 .45.187c.169.134.273.241.432.393.24.227.414.089.534.02.208-.122.369-.219.984-.208.633.011 1.363.237 1.514 1.317.168 1.199-1.966 4.289-1.817 5.722.106 1.01 1.815.299 1.96 1.22.186 1.198-2.136.753-2.667.493-.832-.408-1.337-1.34-1.12-2.26.16-.688 1.7-3.498 1.757-3.93.059-.44-.177-.476-.324-.484-.19-.01-.34.081-.526.362-.169.255-2.082 4.085-2.248 4.398-.296.56-.67.694-1.044.674-.548-.029-.798-.32-.72-.848.047-.31 1.26-3.049 1.323-3.476.039-.265-.013-.546-.275-.68-.263-.135-.572.07-.664.227-.128.215-1.848 4.706-2.032 5.038-.316.576-.65.76-1.152.784-1.186.056-2.065-.92-1.678-2.116.173-.532 1.316-4.571 1.895-5.599.389-.69 1.468-1.216 2.217-.892.387.167.925.437 1.084.507.366.163.759-.277.913-.412.155-.134.302-.276.49-.357.142-.06.343-.095.532-.094zm10.88 2.057a.468.468 0 0 0-.093.011.467.467 0 0 0-.36.555.47.47 0 0 0 .557.36.47.47 0 0 0 .36-.557.47.47 0 0 0-.464-.37zm-22.518.81a.997.997 0 0 0-.832.434 1 1 0 1 0 1.39-.258 1 1 0 0 0-.558-.176zm21.294 2.094a.635.635 0 0 0-.127.013.627.627 0 0 0-.48.746.628.628 0 0 0 .746.483.628.628 0 0 0 .482-.746.63.63 0 0 0-.621-.496zm-18.24 6.097a.453.453 0 0 0-.092.012.464.464 0 1 0 .195.908.464.464 0 0 0 .356-.553.465.465 0 0 0-.459-.367zm13.675 1.55a1.044 1.044 0 0 0-.583.187 1.047 1.047 0 1 0 1.456.265 1.044 1.044 0 0 0-.873-.451zM11.4 22.154a.643.643 0 0 0-.36.115.646.646 0 0 0-.164.899.646.646 0 0 0 .899.164.646.646 0 0 0 .164-.898.646.646 0 0 0-.54-.28z"></path></svg> </a> <div class=text-muted>© Copyright 2022, <a href="https://georgekosmidis.net/" target=_blank rel=noopener>George Kosmidis</a> <br> Is lawyer the most boring job in the world? Read the <a href=/privacy.html>Privacy Policy</a> to find out. <br><small class=text-black-50>Last Build: 2025-07-01T03:28:55+00:00 </small> </div> </div> </footer><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js integrity=sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p crossorigin=anonymous nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><script src=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><script src=https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.4.0/highlight.min.js integrity="sha256-GCgWKkl4RE3+M/TNH5d/F80Tz30PQT+Oubq5Q3I5c20=" crossorigin=anonymous nonce=31e0b69a-8356-480a-9a8a-7336997af6a2></script><script nonce=31e0b69a-8356-480a-9a8a-7336997af6a2>hljs.highlightAll();</script><script nonce=31e0b69a-8356-480a-9a8a-7336997af6a2>window.cookieconsent.initialise({"palette":{"popup":{"background":"#343c66","text":"#cfcfe8"},"button":{"background":"#f71559"}},"showLink":false,"theme":"classic","content":{"message":"Cookie Warning! My blog uses Google Analytics so Google knows you are here. Maybe others too, including FBI, CIA, NASA, ESA, IIS and other acronyms. If you don't like it, you must unfortunately go :(","dismiss":"It's just code, I 'll stay!"}});</script></body></html>